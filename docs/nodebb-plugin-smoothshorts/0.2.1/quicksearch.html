<html>
<head>
</head>
<body style="background: transparent;">
    <script src="scripts/docstrap.lib.js"></script>
    <script src="scripts/lunr.min.js"></script>
    <script src="scripts/fulltext-search.js"></script>

    <script type="text/x-docstrap-searchdb">
    {"public_scripts_config.js.html":{"id":"public_scripts_config.js.html","title":"Source: public/scripts/config.js","body":" Documentation Namespaces contextmenucontrollerhelpersettingssockets Classes HashedPostHashedTopic Global SmoothShorts Source: public/scripts/config.js /* global define socket */ define('plugins/smoothshorts/settings', function() { /** * Provides plugin's settings * @exports plugins/smoothshorts/settings * @namespace settings */ var settings = { /** * Modifier key (ctrl, alt or shift) to enable URL replacement * @type {string} */ modKey: '', /** * Short URLs will use this domain, if set * @type {string} */ forcedDomain: '' }; /** * Load settings from backend * @memberOf settings * @param {Function} cb - Called when settings have been received */ settings.load = function(cb) { socket.emit('plugins.SmoothShorts.getConfig', function(data) { settings.modKey = data.modKey; settings.forcedDomain = data.forcedDomain; return cb(); }); }; return settings; }); × Search results Close Documentation generated by JSDoc 3.4.0 on 2016-04-14T06:45:42+02:00 using the DocStrap template. "},"public_scripts_contextmenu.js.html":{"id":"public_scripts_contextmenu.js.html","title":"Source: public/scripts/contextmenu.js","body":" Documentation Namespaces contextmenucontrollerhelpersettingssockets Classes HashedPostHashedTopic Global SmoothShorts Source: public/scripts/contextmenu.js /* global define */ define('plugins/smoothshorts/contextmenu', ['plugins/smoothshorts/settings'], function(settings) { /** * Provides context menu method * @exports plugins/smoothshorts/contextmenu * @namespace contextmenu */ var cmenu = { /** * Indicates whether context menu is open * @memberof contextmenu * @type {Boolean} */ menuCalled: false, /** * Element context menu has been called on * @memberof contextmenu * @type {HTMLAnchorElement} */ lastCalledOn: null, /** * href value to restore on [lastCalledOn]{@link contextmenu.lastCalledOn} * @memberof contextmenu * @type {String} */ lastOriginalURL: '' }; /** * Sets hooks 'contextmenu' on given HashedPost|Topic's anchors * and 'mousedown' on document. * @memberof contextmenu * @param {(HashedPost|HashedTopic)} HashedObject */ cmenu.setHooks = function(HashedObject) { HashedObject.anchors.forEach(function(obj) { obj.addEventListener('contextmenu', replaceWithShortURL, false); }); document.addEventListener('mousedown', restoreOriginalURL, false); }; /** * Restores [lastOriginalURL]{@link module:plugins/smoothshorts/contextmenu.lastOriginalURL} * on [lastCalledOn]{@link contextmenu.lastCalledOn} * @memberof contextmenu * @inner * @param {MouseEvent} event */ function restoreOriginalURL(event) { if (cmenu.menuCalled) { cmenu.lastCalledOn.href = cmenu.lastOriginalURL; cmenu.lastOriginalURL = ''; cmenu.menuCalled = false; cmenu.lastCalledOn = null; } } /** * Replaces href of an anchor with short URL. * @memberof contextmenu * @inner * @param {MouseEvent} event */ function replaceWithShortURL(event) { var hash; var clickedAnchor = event.target.dataset.smoothhash ? event.target : $(event.target).parents('[data-smoothhash]')[0]; if ((settings.modKey !== '' &amp;&amp; !event[settings.modKey + 'Key']) || !clickedAnchor) { return; } hash = clickedAnchor.dataset.smoothhash; cmenu.menuCalled = true; cmenu.lastCalledOn = clickedAnchor; cmenu.lastOriginalURL = cmenu.lastCalledOn.href; cmenu.lastCalledOn.href = prepareUrl(hash); } /** * Builds short URL. * @memberof contextmenu * @inner * @param {string} hash * @return {string} */ function prepareUrl(hash) { if (settings.forcedDomain !== '') { return '//' + settings.forcedDomain + '/ss/' + hash; } else { return '/ss/' + hash; } } return cmenu; }); × Search results Close Documentation generated by JSDoc 3.4.0 on 2016-04-14T06:45:43+02:00 using the DocStrap template. "},"public_scripts_controller.js.html":{"id":"public_scripts_controller.js.html","title":"Source: public/scripts/controller.js","body":" Documentation Namespaces contextmenucontrollerhelpersettingssockets Classes HashedPostHashedTopic Global SmoothShorts Source: public/scripts/controller.js /* global require ajaxify app */ (function() { 'use strict'; var deps = [ 'plugins/smoothshorts/settings', 'plugins/smoothshorts/helper', 'plugins/smoothshorts/sockets', 'plugins/smoothshorts/contextmenu', 'plugins/smoothshorts/hashed/post', 'plugins/smoothshorts/hashed/topic' ]; require(deps, function(settings, helper, sockets, cmenu, HashedPost, HashedTopic) { /** @namespace controller */ /** * NodeBB's ajaxify.data object * (showing only properties plugin is working with) * @typedef {Object} controller~AjaxifyData * @memberOf controller * @property {?Array.&lt;controller~CategoryData&gt;} categories * @property {?Array.&lt;controller~PostData&gt;} posts * @property {?Array.&lt;controller~TopicData&gt;} topics */ /** * Ajaxify data, describing a teaser * (showing only properties plugin is working with) * @typedef {Object} controller~TeaserData * @memberOf controller * @property {?string} pid - Introduced in NodeBB v1.0.3; earlier versions need to get it with {@link controller~ensureTeaserPids} * @property {string} url - URL to post */ /** * Ajaxify data, describing a category * (showing only properties plugin is working with) * @typedef {Object} controller~CategoryData * @property {Array.&lt;controller~PostData&gt;} posts - First entry is the teaser post. {@link controller~ensureTeaserPids} uses it, when [teaser object]{@link controller~TeaserData} has no pid. * @property {controller~TeaserData} teaser */ /** * Ajaxify data, describing a topic * (showing only properties plugin is working with) * @typedef {Object} controller~TopicData * @memberOf controller * @property {string} slug - Topic's URL slug * @property {string} tid - Topic's ID * @property {string} postcount - Total number of posts in topic * @property {string} title - Topic's title * @property {?controller~TeaserData} teaser - Topic's teaser */ /** * Ajaxify data, describing a post * (showing only properties plugin is working with) * @typedef {Object} controller~PostData * @memberOf controller * @property {controller~TopicData} topic - Topic the post belongs to * @property {number} index - Index of post in topic * @property {string} pid - Post's ID */ /** * Type identifier for HashedPost or HashedTopic * @typedef {string} controller~hashedType * @memberOf controller */ /** * Parses [AjaxifyData]{@link controller~AjaxifyData} for posts/categories/topics * @memberOf controller * @inner */ function parseAjaxifyData() { var data = ajaxify.data; var dataKey = data.topics ? 'topics' : data.categories ? 'categories' : null; var pageData = dataKey ? data[dataKey] : void 0; if (data.posts) { sockets.getHashes('posts', data.posts.map(mapHelperDelegate('posts')), addHashes); } else if (pageData) { ensureTeaserPids(pageData); sockets.getHashes('posts', data[dataKey].filter(helper.teaserFilter).map(mapHelperDelegate('teaser', pageData)), addHashes); if (dataKey === 'topics') { sockets.getHashes('topics', data[dataKey].map(mapHelperDelegate('topics')), addHashes); } } } /** * Ensures that teaser objects have a pid. * @memberOf controller * @inner * @param {controller~AjaxifyData} pageData */ function ensureTeaserPids(pageData) { if (teasersHavePids(pageData)) { return pageData; } return pageData.map(function(dataObject) { if (dataObject.teaser) { dataObject.teaser.pid = dataObject.posts[0].pid; } return dataObject; }); } /** * Checks whether current pages teaser objects have pids * @memberOf controller * @inner * @param {controller~AjaxifyData} pageData * @return {bool} - Result of an [].some() run. If one teaser has a pid, all do. */ function teasersHavePids(pageData) { return pageData.some(function(dataObject) { return dataObject.teaser &amp;&amp; dataObject.teaser.pid !== void 0; }); } function mapHelperDelegate(type) { return function mapHelper(mapObj) { var fn = helper[type + 'Map']; return fn(mapObj, type === 'topics' ? HashedTopic : HashedPost); }; } /** * Parses incoming controller~AjaxifyData when user scrolling * triggers loading new entries * @memberOf controller * @inner * @param {SomeJQueryEventObject} event * @param {controller~AjaxifyData} data */ function addOnScrollLoad(event, data) { var type = event.type.split(':')[1]; sockets.getHashes(type, data[type].map(mapHelperDelegate(type)), addHashes); } /** * Adds from backend received hashes to topic and post links * @memberOf controller * @inner * @param {controller~hashedType} type * @param {Array.&lt;HashedPost|HashedTopic&gt;} hashedObjects - Objects to add hashes for */ function addHashes(type, hashedObjects) { hashedObjects.forEach(function(obj) { obj.addHashToAnchor(); cmenu.setHooks(obj); if (obj instanceof HashedPost &amp;&amp; obj.shouldHaveButton() &amp;&amp; !obj.hasButton()) { obj.addButton(buttonClickDelegate); } }); } function buttonClickDelegate(hashedPost) { /** * One-click button click handler * @memberOf controller * @inner */ var copyShortUrl = function() { var isCopied; var url = hashedPost.shortUrlContainer.value; hashedPost.shortUrlContainer.select(); isCopied = document.execCommand('copy'); require(['translator'], function(translator) { var stringTag = translator.compile('smoothshorts:hashbutton.' + (isCopied ? 'success' : 'error'), (isCopied ? url : void 0)); translator.translate(stringTag, 'en_GB', function(message) { if (isCopied) { app.alertSuccess(message); } else { app.alertError(message); } }); }); }; return copyShortUrl; } /** * Entry point; sets hooks * @memberOf controller * @inner */ function init() { $(window).on('action:ajaxify.contentLoaded', parseAjaxifyData); $(window).on('action:topics.loaded action:posts.loaded', addOnScrollLoad); parseAjaxifyData(); } settings.load(init); }); })(); × Search results Close Documentation generated by JSDoc 3.4.0 on 2016-04-14T06:45:43+02:00 using the DocStrap template. "},"public_scripts_hashed_post.js.html":{"id":"public_scripts_hashed_post.js.html","title":"Source: public/scripts/hashed/post.js","body":" Documentation Namespaces contextmenucontrollerhelpersettingssockets Classes HashedPostHashedTopic Global SmoothShorts Source: public/scripts/hashed/post.js /* global define ajaxify app */ (function() { var deps = [ 'plugins/smoothshorts/settings', 'plugins/smoothshorts/helper' ]; define('plugins/smoothshorts/hashed/post', deps, function(settings, helper) { 'use strict'; /** * Represents a shortened post URL * @constructs HashedPost * @param {!Object} data * @param {!string} data.pid * @param {?string} data.url * @param {?number} data.index * @param {!Object} data.topicData * @param {!string} data.topicData.title * @param {?string} data.topicData.slug */ var HashedPost = function(data) { /** * Posts's URL * @instance * @type {string} */ this.url = data.url || '/topic/' + data.topicData.slug + '/' + data.index; /** * Post's ID * @instance * @type {number} */ this.pid = data.pid; /** * Index of post in its topic * @instance * @type {number} */ this.index = !isNaN(data.index) ? data.index : parseInt(data.url.match(/\\d*(?:#.*)?$/), 10); /** * Anchor elements using post's URL * @instance * @type {Array.&lt;HTMLAnchorElement&gt;} */ this.anchors = getAnchors(this.url, data.topicData.title); /** * Hash used for this post's short URL * @instance * @type {string} */ this.hash = null; /** * smoothshorts/copybutton component * @instance * @type {HTMLDivElement} */ this.button = null; /** * Text input element to copy short URL from * @instance * @type {HTMLInputElement} */ this.shortUrlContainer = null; return this; }; /** * Adds data-smoothhash=&quot;[hash]{@link HashedPost#hash}&quot; to * all [anchors]{@link HashedPost#anchors} * @instance * @memberOf HashedPost * @todo Extract superclass - DRY with {@link HashedTopic#addHashToAnchor} */ HashedPost.prototype.addHashToAnchor = function() { var self = this; this.anchors.forEach(function(anchor) { anchor.dataset.smoothhash = self.hash; }); }; /** * Inserts instances [button]{@link HashedPost#button} directly * after all [anchors]{@link HashedPost#anchors} * @instance * @memberOf HashedPost * @param {controller.buttonClickDelegate} handler - Called on click */ HashedPost.prototype.addButton = function(handler) { var self = this; var buttonData = { shortUrl: buildShortUrl(this.hash) }; app.parseAndTranslate('smoothshorts/copybutton', buttonData, function($element) { $(self.anchors[0]).after($element); $element.children('i').tooltip(); self.button = $element[0]; self.shortUrlContainer = self.button.querySelector('input'); self.button.addEventListener('click', handler.call(null, self)); }); }; /** * Performs tests (e.g. 'copy' command availabilty) whether * [button]{@link HashedPost#button} should be added or not. * @instance * @memberOf HashedPost * @return {bool} False as soon as one test fails */ HashedPost.prototype.shouldHaveButton = function() { var tplRegX = /^topic$|(?:account|groups)\\/(?:posts|profile|best|(?:up|down)voted|details|favourites)/; var itShould = true; switch(false) { case (itShould = document.queryCommandSupported('copy')): break; case (itShould = tplRegX.test(ajaxify.data.template.name)): break; } return itShould; }; /** * Tests whether instance already has a button * @instance * @memberOf HashedPost * @return {Boolean} */ HashedPost.prototype.hasButton = function() { return !!this.button; }; /** * Builds short URL from [hash]{@link HashedPost#hash} and * [forcedDomain]{@link settings.forcedDomain} or current location.host * @inner * @memberOf HashedPost * @param {HashedPost#hash} hash - Instances hash * @return {string} */ function buildShortUrl(hash) { var origin = settings.forcedDomain ? location.origin.replace(location.host, settings.forcedDomain) : location.origin; var path = '/ss/' + hash; return origin + path; } /** * Collects anchor elements from DOM and stores them * in instances [anchors]{@link HashedPost#anchors} * @inner * @memberOf HashedPost * @param {string} url - URL to find anchors * @param {string} topicTitle - Title of post's topic to filter topic links * @todo Extract superclass - DRY with {@link HashedTopic~getAnchors} */ function getAnchors(url, topicTitle) { var anchors = document.querySelectorAll(':not([component=&quot;notifications/list&quot;]) a[href=&quot;' + url + '&quot;]'); return helper.ArrayFromNodeList(anchors).filter(function(anchor) { return anchor.textContent !== topicTitle; }); } return HashedPost; }); })(); × Search results Close Documentation generated by JSDoc 3.4.0 on 2016-04-14T06:45:43+02:00 using the DocStrap template. "},"public_scripts_hashed_topic.js.html":{"id":"public_scripts_hashed_topic.js.html","title":"Source: public/scripts/hashed/topic.js","body":" Documentation Namespaces contextmenucontrollerhelpersettingssockets Classes HashedPostHashedTopic Global SmoothShorts Source: public/scripts/hashed/topic.js /* global define */ define('plugins/smoothshorts/hashed/topic', ['plugins/smoothshorts/helper'], function(helper) { 'use strict'; /** * Represents a shortened topic URL * @constructs HashedTopic * @param {!Object} data * @param {!string} data.slug * @param {!string} data.tid * @param {!string} data.postcount * @param {!string} data.title */ var HashedTopic = function(data) { /** * Topic's URL * @instance * @type {string} */ this.url = '/topic/' + data.slug; /** * Topic's ID * @instance * @type {number} */ this.tid = data.tid; /** * Anchor elements using topic's URL * @instance * @type {Array.&lt;HTMLAnchorElement&gt;} */ this.anchors = getAnchors(this.url, data.postcount, data.title); /** * Hash used for this topic's short URL * @instance * @type {string} */ this.hash = null; return this; }; /** * Adds data-smoothhash=&quot;[hash]{@link HashedTopic#hash}&quot; to * all [anchors]{@link HashedTopic#anchors} * @instance * @memberOf HashedTopic * @todo Extract superclass - DRY with {@link HashedPost#addHashToAnchor} */ HashedTopic.prototype.addHashToAnchor = function() { var self = this; this.anchors.forEach(function(anchor) { anchor.dataset.smoothhash = self.hash; }); }; /** * Collects anchor elements from DOM and stores them * in instances [anchors]{@link HashedTopic#anchors} * @inner * @memberOf HashedTopic * @param {!string} url - URL to find anchors * @param {!string} postcount - Topic's postcount to filter out something - forgot what, though; might even be deprecated... ^_^ * @param {!string} title - Topic's title to filter out false selector positives * @todo Extract superclass - DRY with {@link HashedPost~getAnchors} */ function getAnchors(url, postcount, title) { var anchors = document.querySelectorAll('[component=&quot;category/topic&quot;] a'); return helper.ArrayFromNodeList(anchors).filter(function(element) { return (postcount === '1' &amp;&amp; element.getAttribute('href') === url) || (element.textContent.trim() === title); }); } return HashedTopic; }); × Search results Close Documentation generated by JSDoc 3.4.0 on 2016-04-14T06:45:43+02:00 using the DocStrap template. "},"public_scripts_helper.js.html":{"id":"public_scripts_helper.js.html","title":"Source: public/scripts/helper.js","body":" Documentation Namespaces contextmenucontrollerhelpersettingssockets Classes HashedPostHashedTopic Global SmoothShorts Source: public/scripts/helper.js /* global define ajaxify */ define('plugins/smoothshorts/helper', function() { 'use strict'; /** * Provides helper functions (for e.g. [].map, [].filter) * @exports plugins/smoothshorts/helper * @namespace helper */ var helper = {}; /** * Polyfill for Array.from * @memberOf helper * @static * @param {NodeList} nodeList - List of HTMLAnchorElements */ helper.ArrayFromNodeList = function(nodeList) { if (!Array.from) { var nodeArray = []; for (var i = 0; i &lt; nodeList.length; i++) { nodeArray.push(nodeList.item(i)); } return nodeArray; } else { return Array.from(nodeList); } }; /** * Maps controller~TopicData into HashedTopic objects * @memberOf helper * @static * @param {controller~TopicData} topic * @param {HashedTopic} HashedTopic - NOT an instance! * @return {HashedTopic} - New HashedTopic instance */ helper.topicsMap = function(topic, HashedTopic) { return new HashedTopic({ slug: topic.slug, tid: topic.tid, postcount: topic.postcount, title: topic.title }); }; /** * Maps controller~PostData into HashedPost objects * @memberOf helper * @static * @param {controller~PostData} post * @param {HashedPost} HashedPost - NOT an instance! * @return {HashedPost} - New HashedPost instance */ helper.postsMap = function(post, HashedPost) { var topicTitle = post.topic ? post.topic.title : ajaxify.data.title; var topicSlug = post.topic ? post.topic.slug : ajaxify.data.slug; var index = post.topic ? post.index : post.index + 1; return new HashedPost({ pid: post.pid, url: null, index: index, topicData: { title: topicTitle, slug: topicSlug } }); }; /** * Maps controller~TeaserData into HashedPost objects * @memberOf helper * @static * @param {controller~TeaserData} topic * @param {HashedPost} HashedPost - NOT an instance! * @return {HashedPost} - New HashedPost instance */ helper.teaserMap = function(topic, HashedPost) { return new HashedPost({ pid: topic.teaser.pid, url: topic.teaser.url, index: topic.teaser.index, topicData: { title: topic.title, slug: topic.slug } }); }; /** * Filters out TopicData or CategoryData objects without TeaserData member * @memberOf helper * @static * @param {controller~TopicData|controller~CategoryData} obj [description] * @return {bool} */ helper.teaserFilter = function(obj) { return !!obj.teaser; }; return helper; }); × Search results Close Documentation generated by JSDoc 3.4.0 on 2016-04-14T06:45:43+02:00 using the DocStrap template. "},"smoothshorts_be.js.html":{"id":"smoothshorts_be.js.html","title":"Source: smoothshorts_be.js","body":" Documentation Namespaces contextmenucontrollerhelpersettingssockets Classes HashedPostHashedTopic Global SmoothShorts Source: smoothshorts_be.js 'use strict'; var nconf = require.main.require('nconf'); var winston = require.main.require('winston'); var async = require.main.require('async'); var db = require.main.require('./src/database'); var PluginSocket = require.main.require('./src/socket.io/plugins'); var AdminSocket = require.main.require('./src/socket.io/admin'); var xxh = require('xxhash'); /** open world **/ var SmoothShorts = { useModKey: false, modKey: '', useDomain: false, forcedDomain: '' }; SmoothShorts.init = function(app, cb) { app.router.get('/ss/:hash', SmoothShorts.resolveHash); app.router.get('/admin/plugins/smoothshorts', app.middleware.applyCSRF, app.middleware.admin.buildHeader, SmoothShorts.Admin.render); app.router.get('/api/admin/plugins/SmoothShorts', app.middleware.applyCSRF, SmoothShorts.Admin.render); app.router.post('/api/admin/plugins/smoothshorts/save', app.middleware.applyCSRF, SmoothShorts.Admin.saveSettings); db.getObject('settings:smoothshorts', function(err, config) { if (err) { return cb(err); } if (config) { SmoothShorts.useModKey = (config.useModKey === 'true'); SmoothShorts.modKey = (config.modKey) ? config.modKey : ''; SmoothShorts.useDomain = (config.useDomain === 'true'); SmoothShorts.forcedDomain = (config.forcedDomain) ? config.forcedDomain : ''; } }); PluginSocket.SmoothShorts = {}; PluginSocket.SmoothShorts.getTopicHashes = function(socket, tids, cb) { async.map(tids, SmoothShorts.getHashForTid, function(err, hashs) { if (err) { return cb(err); } cb(null, hashs); }); }; PluginSocket.SmoothShorts.getPostHashes = function(socket, pids, cb) { async.map(pids, SmoothShorts.getHashForPid, function(err, hashs) { if (err) { return cb(err); } cb(null, hashs); }); }; PluginSocket.SmoothShorts.getConfig = function(socket, cb) { var data = { modKey: (SmoothShorts.useModKey) ? SmoothShorts.modKey : '', forcedDomain: (SmoothShorts.useDomain) ? SmoothShorts.forcedDomain : '' }; cb(data); }; return cb(null, app); }; SmoothShorts.resolveHash = function(req, res, cb) { var hash = req.params.hash; async.parallel({ isPost: function(next) { db.isSortedSetMember('posts:smoothshorts', hash, next); }, isTopic: function(next) { db.isSortedSetMember('topics:smoothshorts', hash, next); } }, function(err, result) { if (err) { return cb(err); } else if (result.isPost) { async.waterfall([ function(next) { db.sortedSetScore('posts:smoothshorts', hash, next); }, function(pid, next) { db.getObjectField('post:' + pid, 'tid', function(err, tid) { if (err) { return cb(err); } return next(null, {pid: pid, tid: tid}); }); }, function(data, next) { async.parallel({ rank: function(next) { db.sortedSetRank('tid:' + data.tid + ':posts', data.pid, next); }, slug: function(next) { db.getObjectField('topic:' + data.tid, 'slug', next); } }, function(err, result) { if (err) { return cb(err); } var pIndex = (result.rank !== null) ? (parseInt(result.rank, 10) + 2).toString() : '1'; var uri = '/topic/' + result.slug + '/' + pIndex; next(null, uri); }); } ], function(err, uri) { if (err) { return cb(err); } winston.verbose('[plugins:SmoothShorts] Redirecting ' + hash + ' to ' + uri); res.redirect(uri); }); } else if (result.isTopic) { /* if this hash points to a topic */ async.waterfall([ function(next) { db.sortedSetScore('topics:smoothshorts', hash, next); }, function(tid, next) { db.getObjectField('topic:' + tid, 'slug', next); } ], function(err, slug) { if (err) { return cb(err); } // build URI var uri = '/topic/' + slug + '/'; winston.verbose('[plugins:SmoothShorts] Redirecting ' + hash + ' to ' + uri); // redirect user to URI res.redirect(uri); }); } else { winston.warn('[plugins:SmoothShorts] Couldn\\'t resolve ' + hash); cb(null); } }); }; SmoothShorts.shortenTopic = function(topicData, cb) { /** topics:smoothshorts sortedSet **/ // key is generated from 'NodeBB secret' var key = nconf.get('secret'); key = parseInt('0x' + key.substring(0, key.indexOf('-')), 16); // hash topic object var hash = xxh.hash(new Buffer(JSON.stringify(topicData)), key).toString(16); // don't take any chances of leaking the secret around; // not even just parts of it. ;) key = null; db.sortedSetAdd('topics:smoothshorts', topicData.tid, hash, function(err) { if (!err) { winston.verbose('[plugin:smoothshorts] Hashed \\'' + topicData.title + '\\' (ID: ' + topicData.tid + ')'); if (cb) { cb(); } } else { winston.error('[plugin:smoothshorts] Writing hash to DB failed.' + '(tid=' + topicData.tid + ')'); if (cb) { cb(err); } } }); // next(null, topicData); }; SmoothShorts.purgeTopic = function(tid) { db.sortedSetsRemoveRangeByScore(['topics:smoothshorts'], tid, tid, function(err) { if (err) { winston.error('[plugin:smoothshorts] Deleting hash from DB failed.' + '(tid=' + tid + ')'); } else { winston.verbose('[plugin:smoothshorts] Deleted hash for topic ID ' + tid); } }); }; SmoothShorts.shortenPost = function(postData, cb) { /** posts:smoothshorts sortedSet **/ // key is generated from 'NodeBB secret' var key = nconf.get('secret'); key = parseInt('0x' + key.substring(0, key.indexOf('-')), 16); // hash post object var hash = xxh.hash(new Buffer(JSON.stringify(postData)), key).toString(16); // don't take any chances of leaking the secret around; // not even just parts of it. ;) key = null; db.sortedSetAdd('posts:smoothshorts', postData.pid, hash, function(err) { if (!err) { winston.verbose('[plugin:smoothshorts] Hashed post ID ' + postData.pid); if (cb) { cb(); } } else { winston.error('[plugin:smoothshorts] Writing hash to DB failed.' + '(pid=' + postData.pid + ')'); winston.error(err); if (cb) { cb(err); } } }); }; SmoothShorts.purgePost = function(pid) { winston.verbose('[plugin:smoothshorts] Purging Post: ' + pid); db.sortedSetsRemoveRangeByScore(['posts:smoothshorts'], pid, pid, function(err) { if (err) { winston.error('[plugin:smoothshorts] Deleting hash from DB failed.' + '(pid=' + pid + ')'); } else { winston.verbose('[plugin:smoothshorts] Deleted hash for post ID ' + pid); } }); }; SmoothShorts.getHashForTid = function(tid, cb) { db.getSortedSetRangeByScore('topics:smoothshorts', 0, -1, tid, tid, function(err, hash) { if (err) { return cb(err); } cb(null, {tid: tid, hash: hash[0]}); }); }; SmoothShorts.getHashForPid = function(pid, cb) { db.getSortedSetRangeByScore('posts:smoothshorts', 0, -1, pid, pid, function(err, hash) { if (err) { return cb(err); } cb(null, {pid: pid, hash: hash[0]}); }); }; /** admin's cave **/ SmoothShorts.Admin = {}; SmoothShorts.Admin.addMenuItem = function(custom_header, cb) { custom_header.plugins.push({ route: '/plugins/smoothshorts', icon: 'fa-location-arrow', name: 'SmoothShorts' }); cb(null, custom_header); }; SmoothShorts.Admin.render = function(req, res, next) { var data = { csrf: req.csrfToken() }; async.parallel({ postCount: function(next) { db.sortedSetCard('posts:pid', next); }, postHashCount: function(next) { db.sortedSetCard('posts:smoothshorts', next); }, topicCount: function(next) { db.sortedSetCard('topics:tid', next); }, topicHashCount: function(next) { db.sortedSetCard('topics:smoothshorts', next); } }, function(err, result) { if (err) { return next(err); } // left side, &quot;Settings&quot; data.modKey = {}; data.modKey[SmoothShorts.modKey] = true; data.useModKey = SmoothShorts.useModKey; data.useDomain = SmoothShorts.useDomain; data.forcedDomain = SmoothShorts.forcedDomain; // right side, &quot;Status&quot; data.postCount = result.postCount; data.postHashCount = result.postHashCount; data.topicCount = result.topicCount; data.topicHashCount = result.topicHashCount; data.postStatus = (data.postCount !== data.postHashCount) ? 'cout-warn' : ''; data.topicStatus = (data.topicCount !== data.topicHashCount) ? 'cout-warn' : ''; res.render('admin/plugins/smoothshorts', data); }); }; SmoothShorts.Admin.saveSettings = function(req, res) { var dbData = { useModKey: req.body.useModKey, modKey: req.body.modKey, useDomain: req.body.useDomain, forcedDomain: req.body.domain }; db.setObject('settings:smoothshorts', dbData, function(err) { if (err) { res.json(500, 'saveError'); } SmoothShorts.useModKey = (dbData.useModKey === 'true'); SmoothShorts.modKey = dbData.modKey; SmoothShorts.useDomain = (dbData.useDomain === 'true'); SmoothShorts.forcedDomain = dbData.forcedDomain; res.json('OK'); }); }; AdminSocket.plugins.SmoothShorts = {}; AdminSocket.plugins.SmoothShorts.hashMissing = function(socket, data, cb) { async.parallel({ postIds: function(next) { db.getSortedSetRevRange('posts:pid', 0, -1, next); }, topicIds: function(next) { db.getSortedSetRevRange('topics:tid', 0, -1, next); } }, function(err, result) { if (err) { return cb(err); } db.getSortedSetRevRangeWithScores('posts:smoothshorts', 0, -1, function(err, hashSet) { if (err) { cb(err); } if (hashSet.length &lt; result.postIds.length) { result.postIds.forEach(function(pid) { for (var i = 0; i &lt; hashSet.length; i++) { if (hashSet[i].score === pid) { return; } } db.getObject('post:' + pid, function(err, postData) { if (err) { return; } SmoothShorts.shortenPost(postData, function(err) { if (!err) { socket.emit('event:smoothshorts.newhash', {type: 'post'}); } }); }); }); } }); db.getSortedSetRevRangeWithScores('topics:smoothshorts', 0, -1, function(err, hashSet) { if (err) { cb(err); } if (hashSet.length &lt; result.topicIds.length) { result.topicIds.forEach(function(tid) { for (var i = 0; i &lt; hashSet.length; i++) { if (hashSet[i].score === tid) { return; } } db.getObject('topic:' + tid, function(err, topicData) { if (err) { return; } SmoothShorts.shortenTopic(topicData, function(err) { if (!err) { socket.emit('event:smoothshorts.newhash', {type: 'topic'}); } }); }); }); } }); }); }; /* not yet implemented - stay tuned for 0.2.0! :) AdminSocket.plugins.SmoothShorts.deleteUnused = function(socket, data, cb) { }; */ module.exports = SmoothShorts; × Search results Close Documentation generated by JSDoc 3.4.0 on 2016-04-14T06:45:43+02:00 using the DocStrap template. "},"public_scripts_sockets.js.html":{"id":"public_scripts_sockets.js.html","title":"Source: public/scripts/sockets.js","body":" Documentation Namespaces contextmenucontrollerhelpersettingssockets Classes HashedPostHashedTopic Global SmoothShorts Source: public/scripts/sockets.js /* global define socket */ define('plugins/smoothshorts/sockets', function() { 'use strict'; /** * Provides socket.io connections to backend * @exports plugins/smoothshorts/sockets * @namespace sockets */ var sockets = {}; /** * Requests hashes * @memberOf sockets * @static * @param {controller~hashedType} type * @param {HashedPost|HashedTopic} hashedObjects - Objects to get hashes for * @param {controller~addHashes} cb */ sockets.getHashes = function(type, hashedObjects, cb) { var ids = hashedObjects.map(function(obj) { return obj[getHashesType[type][1]]; }); socket.emit('plugins.SmoothShorts.' + getHashesType[type][0], ids, function(err, hashes) { if (err) { return console.error(err); } cb(type, hashedObjects.map(function(obj, idx) { obj.hash = hashes[idx].hash; return obj; })); }); }; var getHashesType = { posts: ['getPostHashes', 'pid'], topics: ['getTopicHashes', 'tid'] }; return sockets; }); × Search results Close Documentation generated by JSDoc 3.4.0 on 2016-04-14T06:45:43+02:00 using the DocStrap template. "},"global.html":{"id":"global.html","title":"Global","body":" Documentation Namespaces contextmenucontrollerhelpersettingssockets Classes HashedPostHashedTopic Global SmoothShorts Global Members SmoothShorts open world Source: smoothshorts_be.js, line 12 × Search results Close Documentation generated by JSDoc 3.4.0 on 2016-04-14T06:45:43+02:00 using the DocStrap template. "},"classes.list.html":{"id":"classes.list.html","title":"Classes","body":" Documentation Namespaces contextmenucontrollerhelpersettingssockets Classes HashedPostHashedTopic Global SmoothShorts Classes Classes HashedPost HashedTopic Namespaces contextmenu controller helper settings sockets × Search results Close Documentation generated by JSDoc 3.4.0 on 2016-04-14T06:45:43+02:00 using the DocStrap template. "},"namespaces.list.html":{"id":"namespaces.list.html","title":"Namespaces","body":" Documentation Namespaces contextmenucontrollerhelpersettingssockets Classes HashedPostHashedTopic Global SmoothShorts Namespaces Classes HashedPost HashedTopic Namespaces contextmenu controller helper settings sockets × Search results Close Documentation generated by JSDoc 3.4.0 on 2016-04-14T06:45:43+02:00 using the DocStrap template. "},"index.html":{"id":"index.html","title":"Index","body":" Documentation Namespaces contextmenucontrollerhelpersettingssockets Classes HashedPostHashedTopic Global SmoothShorts nodebb-plugin-smoothshorts 0.2.1 # nodebb-plugin-smoothshorts Seamless short URL plugin for NodeBBNobody likes itchy pants, do you? Neither do I. :smirk: That's why these shorts are seamlessly woven into the NodeBB experience, your users won't feel a thing. Installation npm install nodebb-plugin-smoothshorts Activate the plugin in ACP/Extend/Plugins. Setup plugin (and hash already existing posts/topics) in ACP/Plugins/SmoothShorts. Go click 'em! :D FeaturesOne-click buttonGiven that the client's browser supports the execCommand('copy'), SmoothShorts will add an icon next to post links, which copies the short URL with a single click. The context menu method is always available. NOTE: If you are using NodeBB &gt;=1.0.0, you have a more suitable icon (.fa-hashtag) available. The plugin's default .fa-external-link ensures backwards compatibility. You can change the icon class in the template (copybutton.tpl). Context menuOnce a user opens the browser's context menu upon a topic link, the href value of that link gets replaced with its assigned hash: This also works on posts: (Not all themes have those links; same goes for teasers. Posts are hashed, regardless of used theme.) The now copied address is of the form https://yourNodeBB.org/ss/HASH. Visiting it will redirect to the associated post or topic: Settings (ACP/Plugins/SmoothShorts)###- Modifier key Users would have to press Ctrl/Alt/Shift while opening the context menu in order to replace the link; ###- Forced domain Short urls are forced onto this domain, disregarding which the user chose to visit the board. Q/A &amp; Known Issues###Why not use a service like bit.ly or goo.gl? Coming in 0.3.0!For two reasons: 1. While investigating bit.ly, I noticed that they impose limits on calls to their API. No need to hate them for it; in fact, they have every right to do so, protecting themselves against bots and such. But unfortunately, as hashing is triggered by every user creating a topic/post, a single spam attack on your NodeBB could make you run out of those API calls; just like that. 2. Links to posts in NodeBB are not structured like /topic/topicslug/postID, but rather /topic/topicslug/positionInTopic. Which means that if you purge a post, your already created short urls would get all mixed up. × Search results Close Documentation generated by JSDoc 3.4.0 on 2016-04-14T06:45:43+02:00 using the DocStrap template. "},"contextmenu.html":{"id":"contextmenu.html","title":"Namespace: contextmenu","body":" Documentation Namespaces contextmenucontrollerhelpersettingssockets Classes HashedPostHashedTopic Global SmoothShorts Namespace: contextmenu contextmenu Provides context menu method Source: public/scripts/contextmenu.js, line 5 Members &lt;static&gt; lastCalledOn :HTMLAnchorElement Element context menu has been called on Type: HTMLAnchorElement Source: public/scripts/contextmenu.js, line 22 &lt;static&gt; lastOriginalURL :String href value to restore on lastCalledOn Type: String Source: public/scripts/contextmenu.js, line 28 &lt;static&gt; menuCalled :Boolean Indicates whether context menu is open Type: Boolean Source: public/scripts/contextmenu.js, line 16 Methods &lt;static&gt; cmenu.setHooks(HashedObject) Sets hooks 'contextmenu' on given HashedPost|Topic's anchors and 'mousedown' on document. Parameters: Name Type Description HashedObject HashedPost | HashedTopic Source: public/scripts/contextmenu.js, line 37 &lt;inner&gt; prepareUrl(hash) Builds short URL. Parameters: Name Type Description hash string Source: public/scripts/contextmenu.js, line 88 Returns: Type string &lt;inner&gt; replaceWithShortURL(event) Replaces href of an anchor with short URL. Parameters: Name Type Description event MouseEvent Source: public/scripts/contextmenu.js, line 66 &lt;inner&gt; restoreOriginalURL(event) Restores lastOriginalURL on lastCalledOn Parameters: Name Type Description event MouseEvent Source: public/scripts/contextmenu.js, line 51 × Search results Close Documentation generated by JSDoc 3.4.0 on 2016-04-14T06:45:43+02:00 using the DocStrap template. "},"controller.html":{"id":"controller.html","title":"Namespace: controller","body":" Documentation Namespaces contextmenucontrollerhelpersettingssockets Classes HashedPostHashedTopic Global SmoothShorts Namespace: controller controller Source: public/scripts/controller.js, line 17 Methods &lt;inner&gt; addHashes(type, hashedObjects) Adds from backend received hashes to topic and post links Parameters: Name Type Description type controller~hashedType hashedObjects Array.&lt;(HashedPost|HashedTopic)&gt; Objects to add hashes for Source: public/scripts/controller.js, line 153 &lt;inner&gt; addOnScrollLoad(event, data) Parses incoming controller~AjaxifyData when user scrolling triggers loading new entries Parameters: Name Type Description event SomeJQueryEventObject data controller~AjaxifyData Source: public/scripts/controller.js, line 141 &lt;inner&gt; copyShortUrl() One-click button click handler Source: public/scripts/controller.js, line 169 &lt;inner&gt; ensureTeaserPids(pageData) Ensures that teaser objects have a pid. Parameters: Name Type Description pageData controller~AjaxifyData Source: public/scripts/controller.js, line 101 &lt;inner&gt; init() Entry point; sets hooks Source: public/scripts/controller.js, line 196 &lt;inner&gt; parseAjaxifyData() Parses AjaxifyData for posts/categories/topics Source: public/scripts/controller.js, line 79 &lt;inner&gt; teasersHavePids(pageData) Checks whether current pages teaser objects have pids Parameters: Name Type Description pageData controller~AjaxifyData Source: public/scripts/controller.js, line 120 Returns: Result of an [].some() run. If one teaser has a pid, all do. Type bool Type Definitions AjaxifyData NodeBB's ajaxify.data object (showing only properties plugin is working with) Type: Object Properties: Name Type Argument Description categories Array.&lt;controller~CategoryData&gt; &lt;nullable&gt; posts Array.&lt;controller~PostData&gt; &lt;nullable&gt; topics Array.&lt;controller~TopicData&gt; &lt;nullable&gt; Source: public/scripts/controller.js, line 19 CategoryData Ajaxify data, describing a category (showing only properties plugin is working with) Type: Object Properties: Name Type Description posts Array.&lt;controller~PostData&gt; First entry is the teaser post. controller~ensureTeaserPids uses it, when teaser object has no pid. teaser controller~TeaserData Source: public/scripts/controller.js, line 38 hashedType Type identifier for HashedPost or HashedTopic Type: string Source: public/scripts/controller.js, line 68 PostData Ajaxify data, describing a post (showing only properties plugin is working with) Type: Object Properties: Name Type Description topic controller~TopicData Topic the post belongs to index number Index of post in topic pid string Post's ID Source: public/scripts/controller.js, line 58 TeaserData Ajaxify data, describing a teaser (showing only properties plugin is working with) Type: Object Properties: Name Type Argument Description pid string &lt;nullable&gt; Introduced in NodeBB v1.0.3; earlier versions need to get it with controller~ensureTeaserPids url string URL to post Source: public/scripts/controller.js, line 29 TopicData Ajaxify data, describing a topic (showing only properties plugin is working with) Type: Object Properties: Name Type Argument Description slug string Topic's URL slug tid string Topic's ID postcount string Total number of posts in topic title string Topic's title teaser controller~TeaserData &lt;nullable&gt; Topic's teaser Source: public/scripts/controller.js, line 46 × Search results Close Documentation generated by JSDoc 3.4.0 on 2016-04-14T06:45:43+02:00 using the DocStrap template. "},"HashedPost.html":{"id":"HashedPost.html","title":"Class: HashedPost","body":" Documentation Namespaces contextmenucontrollerhelpersettingssockets Classes HashedPostHashedTopic Global SmoothShorts Class: HashedPost HashedPost new HashedPost(data) Represents a shortened post URL Parameters: Name Type Description data Object Properties Name Type Argument Description pid string url string &lt;nullable&gt; index number &lt;nullable&gt; topicData Object Properties Name Type Argument Description title string slug string &lt;nullable&gt; Source: public/scripts/hashed/post.js, line 24 Members anchors :Array.&lt;HTMLAnchorElement&gt; Anchor elements using post's URL Type: Array.&lt;HTMLAnchorElement&gt; Source: public/scripts/hashed/post.js, line 49 button :HTMLDivElement smoothshorts/copybutton component Type: HTMLDivElement Source: public/scripts/hashed/post.js, line 61 hash :string Hash used for this post's short URL Type: string Source: public/scripts/hashed/post.js, line 55 index :number Index of post in its topic Type: number Source: public/scripts/hashed/post.js, line 43 pid :number Post's ID Type: number Source: public/scripts/hashed/post.js, line 37 shortUrlContainer :HTMLInputElement Text input element to copy short URL from Type: HTMLInputElement Source: public/scripts/hashed/post.js, line 67 url :string Posts's URL Type: string Source: public/scripts/hashed/post.js, line 31 Methods addButton(handler) Inserts instances button directly after all anchors Parameters: Name Type Description handler controller.buttonClickDelegate Called on click Source: public/scripts/hashed/post.js, line 92 addHashToAnchor() Adds data-smoothhash=&quot;hash&quot; to all anchors Source: public/scripts/hashed/post.js, line 78 To Do: Extract superclass - DRY with HashedTopic#addHashToAnchor hasButton() Tests whether instance already has a button Source: public/scripts/hashed/post.js, line 127 Returns: Type Boolean shouldHaveButton() Performs tests (e.g. 'copy' command availabilty) whether button should be added or not. Source: public/scripts/hashed/post.js, line 111 Returns: False as soon as one test fails Type bool &lt;inner&gt; buildShortUrl(hash) Builds short URL from hash and forcedDomain or current location.host Parameters: Name Type Description hash HashedPost#hash Instances hash Source: public/scripts/hashed/post.js, line 139 Returns: Type string &lt;inner&gt; getAnchors(url, topicTitle) Collects anchor elements from DOM and stores them in instances anchors Parameters: Name Type Description url string URL to find anchors topicTitle string Title of post's topic to filter topic links Source: public/scripts/hashed/post.js, line 156 To Do: Extract superclass - DRY with HashedTopic~getAnchors × Search results Close Documentation generated by JSDoc 3.4.0 on 2016-04-14T06:45:43+02:00 using the DocStrap template. "},"HashedTopic.html":{"id":"HashedTopic.html","title":"Class: HashedTopic","body":" Documentation Namespaces contextmenucontrollerhelpersettingssockets Classes HashedPostHashedTopic Global SmoothShorts Class: HashedTopic HashedTopic new HashedTopic(data) Represents a shortened topic URL Parameters: Name Type Description data Object Properties Name Type Description slug string tid string postcount string title string Source: public/scripts/hashed/topic.js, line 15 Members anchors :Array.&lt;HTMLAnchorElement&gt; Anchor elements using topic's URL Type: Array.&lt;HTMLAnchorElement&gt; Source: public/scripts/hashed/topic.js, line 33 hash :string Hash used for this topic's short URL Type: string Source: public/scripts/hashed/topic.js, line 39 tid :number Topic's ID Type: number Source: public/scripts/hashed/topic.js, line 27 url :string Topic's URL Type: string Source: public/scripts/hashed/topic.js, line 21 Methods addHashToAnchor() Adds data-smoothhash=&quot;hash&quot; to all anchors Source: public/scripts/hashed/topic.js, line 50 To Do: Extract superclass - DRY with HashedPost#addHashToAnchor &lt;inner&gt; getAnchors(url, postcount, title) Collects anchor elements from DOM and stores them in instances anchors Parameters: Name Type Description url string URL to find anchors postcount string Topic's postcount to filter out something - forgot what, though; might even be deprecated... ^_^ title string Topic's title to filter out false selector positives Source: public/scripts/hashed/topic.js, line 67 To Do: Extract superclass - DRY with HashedPost~getAnchors × Search results Close Documentation generated by JSDoc 3.4.0 on 2016-04-14T06:45:43+02:00 using the DocStrap template. "},"helper.html":{"id":"helper.html","title":"Namespace: helper","body":" Documentation Namespaces contextmenucontrollerhelpersettingssockets Classes HashedPostHashedTopic Global SmoothShorts Namespace: helper helper Provides helper functions (for e.g. [].map, [].filter) Source: public/scripts/helper.js, line 6 Methods &lt;static&gt; ArrayFromNodeList(nodeList) Polyfill for Array.from Parameters: Name Type Description nodeList NodeList List of HTMLAnchorElements Source: public/scripts/helper.js, line 19 &lt;static&gt; postsMap(post, HashedPost) Maps controller~PostData into HashedPost objects Parameters: Name Type Description post controller~PostData HashedPost HashedPost NOT an instance! Source: public/scripts/helper.js, line 56 Returns: New HashedPost instance Type HashedPost &lt;static&gt; teaserFilter(obj) Filters out TopicData or CategoryData objects without TeaserData member Parameters: Name Type Description obj controller~TopicData | controller~CategoryData [description] Source: public/scripts/helper.js, line 98 Returns: Type bool &lt;static&gt; teaserMap(topic, HashedPost) Maps controller~TeaserData into HashedPost objects Parameters: Name Type Description topic controller~TeaserData HashedPost HashedPost NOT an instance! Source: public/scripts/helper.js, line 79 Returns: New HashedPost instance Type HashedPost &lt;static&gt; topicsMap(topic, HashedTopic) Maps controller~TopicData into HashedTopic objects Parameters: Name Type Description topic controller~TopicData HashedTopic HashedTopic NOT an instance! Source: public/scripts/helper.js, line 39 Returns: New HashedTopic instance Type HashedTopic × Search results Close Documentation generated by JSDoc 3.4.0 on 2016-04-14T06:45:43+02:00 using the DocStrap template. "},"settings.html":{"id":"settings.html","title":"Namespace: settings","body":" Documentation Namespaces contextmenucontrollerhelpersettingssockets Classes HashedPostHashedTopic Global SmoothShorts Namespace: settings settings Provides plugin's settings Source: public/scripts/config.js, line 5 Methods &lt;static&gt; load(cb) Load settings from backend Parameters: Name Type Description cb function Called when settings have been received Source: public/scripts/config.js, line 28 × Search results Close Documentation generated by JSDoc 3.4.0 on 2016-04-14T06:45:43+02:00 using the DocStrap template. "},"sockets.html":{"id":"sockets.html","title":"Namespace: sockets","body":" Documentation Namespaces contextmenucontrollerhelpersettingssockets Classes HashedPostHashedTopic Global SmoothShorts Namespace: sockets sockets Provides socket.io connections to backend Source: public/scripts/sockets.js, line 6 Methods &lt;static&gt; getHashes(type, hashedObjects, cb) Requests hashes Parameters: Name Type Description type controller~hashedType hashedObjects HashedPost | HashedTopic Objects to get hashes for cb controller~addHashes Source: public/scripts/sockets.js, line 21 × Search results Close Documentation generated by JSDoc 3.4.0 on 2016-04-14T06:45:43+02:00 using the DocStrap template. "}}
    </script>

    <script type="text/javascript">
        $(document).ready(function() {
            Searcher.init();
        });

        $(window).on("message", function(msg) {
            var msgData = msg.originalEvent.data;

            if (msgData.msgid != "docstrap.quicksearch.start") {
                return;
            }

            var results = Searcher.search(msgData.searchTerms);

            window.parent.postMessage({"results": results, "msgid": "docstrap.quicksearch.done"}, "*");
        });
    </script>
</body>
</html>
